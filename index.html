<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Premium Patient Services Dashboard</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
:root{
  --page-bg:#1a1a1a;
  --glass-bg: rgba(50,180,220,0.08);
  --glass-tint: rgba(50,180,220,0.14);
  --border: rgba(255,255,255,0.28);
  --shadow: 0 18px 50px rgba(0,0,0,0.55);
  --accent:#4bb3fd;
}
body{margin:0; font-family:Inter,sans-serif; background:var(--page-bg); color:#fff;}
h1{margin:22px 20px 6px; font-size:28px;font-weight:700;}
.subhead{margin:0 20px 16px;font-size:14px; opacity:.8;}
.filters,.kpi-card,.chart-card,.takeaways-card{
  background: var(--glass-bg);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow: var(--shadow), inset 0 4px 10px rgba(0,0,0,0.1);
}
.kpi-card{background: var(--glass-tint);}
.filters{margin:0 20px 18px; padding:14px; display:flex; flex-wrap:wrap; align-items:flex-end; gap:12px;}
.filters .group{display:flex; flex-direction:column; gap:6px;}
.filters label{font-size:12px; opacity:.85;}
.filters select,.filters input[type="date"],.filters input[type="text"]{
  padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.35);
  background: rgba(255,255,255,.12); color:#fff; min-width:180px;
  outline:none;
}
.filters button{padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.25);
  background: linear-gradient(180deg,var(--accent),#2378ff); color:#fff; font-weight:600; cursor:pointer;}
.filters button:hover{filter:brightness(1.05);}
.kpi-row{display:flex; gap:18px; margin:0 20px 18px; flex-wrap:wrap;}
.kpi-card{flex:1; min-width:220px; padding:18px 18px 14px; position:relative;}
.kpi-title{font-size:12px; opacity:.85; margin:0 0 6px;}
.kpi-value{font-size:28px;font-weight:800; margin:0 0 6px; display:flex; align-items:center; gap:6px;}
.kpi-trend{font-size:14px;}
.kpi-sub{font-size:12px; opacity:.7;}
.charts-row{display:grid; grid-template-columns: repeat(12,1fr); gap:22px; margin:0 20px 22px;}
.chart-card{padding:16px; min-height:360px; transition: all .2s ease;}
.chart-card h2{margin:2px 0 10px;font-size:16px;font-weight:700; border-bottom:1px solid rgba(255,255,255,0.18); padding-bottom:8px;}
.full{grid-column:1 / -1;}
.col-4{grid-column: span 4;}
.col-6{grid-column: span 6;}
.plot{width:100%; height:calc(100% - 46px);}
.takeaways-card{margin:0 20px 40px; padding:18px;}
.takeaways-card h2{margin:4px 0 10px; font-size:18px;}
.takeaways-card ul{margin:8px 0 0 18px;}
.takeaways-card li{margin:8px 0;}
table{width:100%; border-collapse:collapse; margin-top:12px; color:#fff;}
th,td{border:1px solid rgba(255,255,255,0.28); padding:8px; text-align:left;}
th{background: rgba(50,180,220,0.15);}
.chart-card:hover, .kpi-card:hover{box-shadow: 0 24px 60px rgba(0,0,0,0.65); transform:translateY(-2px);}
@media(max-width:1100px){.col-4{grid-column: span 6;}.col-6{grid-column: span 12;}}
@media(max-width:720px){.filters select,.filters input{width:100%;} .kpi-row{flex-direction:column;} .col-4,.col-6,.full{grid-column:1/-1;}}
</style>
</head>
<body>
<h1>Premium Patient Services Dashboard</h1>
<p class="subhead">Filter by Agent, Timeframe, LH#, and Topic. Upload a JSON file to replace sample data.</p>

<div class="filters">
  <div class="group"><label for="jsonUpload">Upload JSON</label><input type="file" id="jsonUpload" accept=".json"/></div>
  <div class="group"><label for="filterAgent">Agent</label><select id="filterAgent"><option value="">All</option></select></div>
  <div class="group"><label for="filterStart">Start Date</label><input type="date" id="filterStart"/></div>
  <div class="group"><label for="filterEnd">End Date</label><input type="date" id="filterEnd"/></div>
  <div class="group"><label for="filterLH">Patient LH#</label><input type="text" id="filterLH" placeholder="Enter LH#"/></div>
  <div class="group"><label for="filterTopic">Topic</label><select id="filterTopic"><option value="">All</option></select></div>
  <div class="group" style="align-self:end;"><button id="applyBtn">Apply Filters</button></div>
</div>

<div class="kpi-row">
  <div class="kpi-card" id="kpiTotalCalls">
    <p class="kpi-title">Total Calls</p>
    <p class="kpi-value">0 <span class="kpi-trend">↔</span></p>
    <p class="kpi-sub">All filters</p>
  </div>
  <div class="kpi-card" id="kpiAvgDuration">
    <p class="kpi-title">Average Call Duration</p>
    <p class="kpi-value">0 min <span class="kpi-trend">↔</span></p>
    <p class="kpi-sub">Start → Completion</p>
  </div>
  <div class="kpi-card" id="kpiTopTopic">
    <p class="kpi-title">Top Topic</p>
    <p class="kpi-value">— <span class="kpi-trend">↔</span></p>
    <p class="kpi-sub">Most frequent</p>
  </div>
</div>

<div class="charts-row">
  <div class="chart-card full">
    <h2>Call Volume Trendline</h2>
    <div id="callTrend" class="plot"></div>
  </div>
</div>

<div class="charts-row">
  <div class="chart-card col-4">
    <h2>Call Volume by Product</h2>
    <div id="callVolume" class="plot"></div>
  </div>
  <div class="chart-card col-4">
    <h2>Call Volume by Agent</h2>
    <div id="callAgent" class="plot"></div>
  </div>
  <div class="chart-card col-4">
    <h2>Topics by Agent (Stacked)</h2>
    <div id="topicByAgent" class="plot"></div>
  </div>
</div>

<div class="charts-row">
  <div class="chart-card full">
    <h2>Call Outcomes Summary</h2>
    <div id="callOutcomesTable"></div>
  </div>
</div>

<div class="takeaways-card">
  <h2>Key Takeaways & Recommendations</h2>
  <ul id="takeawaysList">
    <li>Agents need clear guidance for moving AE details from Conga email to AgDispatch.</li>
    <li>Create step-by-step resource for saving CCS email content and attaching PDFs.</li>
    <li>Provide short training on email-to-PDF workflow; include quick reference in KB.</li>
    <li>Monitor AE-related calls weekly; prioritize process automation if volume rises.</li>
    <li>Publish searchable KB article for recurring “attachments/options” questions.</li>
  </ul>
</div>

<script>
// ---------------- SAMPLE DATA ----------------
let data = [
  {Agent:"Lauren Clifford", StartTime:"10/02/2024 08:50", CompletionTime:"10/02/2024 08:54", PatientLH:"LH4211126", Product:"Avonex", CallTopic:"Adverse event", Outcome:"Discussed options for attachments"},
  {Agent:"Lauren Clifford", StartTime:"10/03/2024 10:05", CompletionTime:"10/03/2024 10:15", PatientLH:"LH4211150", Product:"Tecfidera", CallTopic:"General inquiry", Outcome:"Provided instructions"},
  {Agent:"Alex Rivera", StartTime:"10/04/2024 14:20", CompletionTime:"10/04/2024 14:31", PatientLH:"LH4211200", Product:"Avonex", CallTopic:"Adverse event", Outcome:"Escalated to safety team"},
  {Agent:"Jamie Chen", StartTime:"10/06/2024 09:00", CompletionTime:"10/06/2024 09:08", PatientLH:"LH4211301", Product:"Tysabri", CallTopic:"Benefits", Outcome:"Scheduled follow-up"}
];

// ---------------- UTILS ----------------
function safeDate(d){ if(!d) return null; const dt=new Date(d); return isNaN(dt)?null:dt; }
function groupCount(arr,key){ const map={}; arr.forEach(o=>{const k=(o[key]||"Unknown"); map[k]=(map[k]||0)+1}); return map; }

// ---------------- JSON UPLOAD ----------------
const agentSelect=document.getElementById('filterAgent');
const topicSelect=document.getElementById('filterTopic');
document.getElementById('jsonUpload').addEventListener('change', function(e){
  const file = e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=function(ev){
    try{
      const parsed=JSON.parse(ev.target.result);
      data=Array.isArray(parsed)?parsed:[parsed];
      populateFilters(); updateDashboard();
    } catch(err){ alert("Invalid JSON file: "+err.message); }
  }
  reader.readAsText(file);
});

// ---------------- FILTERS ----------------
function populateFilters(){
  const agents=[...new Set(data.map(d=>d.Agent))].sort();
  const topics=[...new Set(data.map(d=>d.CallTopic))].sort();
  agentSelect.innerHTML='<option value="">All</option>'+agents.map(a=>`<option value="${a}">${a}</option>`).join('');
  topicSelect.innerHTML='<option value="">All</option>'+topics.map(t=>`<option value="${t}">${t}</option>`).join('');
}
document.getElementById('applyBtn').addEventListener('click', updateDashboard);

// ---------------- DASHBOARD ----------------
function updateDashboard(){
  const fAgent=agentSelect.value.toLowerCase(), fTopic=topicSelect.value.toLowerCase();
  const fLH=document.getElementById('filterLH').value.toLowerCase();
  const fStart=document.getElementById('filterStart').value;
  const fEnd=document.getElementById('filterEnd').value;
  const filtered=data.filter(d=>{
    if(fAgent && d.Agent.toLowerCase()!==fAgent) return false;
    if(fTopic && d.CallTopic.toLowerCase()!==fTopic) return false;
    if(fLH && !d.PatientLH.toLowerCase().includes(fLH)) return false;
    const dt=safeDate(d.StartTime);
    if(fStart && dt<new Date(fStart)) return false;
    if(fEnd && dt>new Date(fEnd)) return false;
    return true;
  });

  // ---------------- KPI ----------------
  const totalCalls=filtered.length;
  document.querySelector('#kpiTotalCalls .kpi-value').innerHTML=totalCalls+' <span class="kpi-trend">↔</span>';
  const durations=filtered.map(d=>{const s=safeDate(d.StartTime),e=safeDate(d.CompletionTime); return s&&e?(e-s)/60000:0;}).filter(v=>v>0);
  const avgDur=Math.round(durations.reduce((a,b)=>a+b,0)/Math.max(durations.length,1));
  document.querySelector('#kpiAvgDuration .kpi-value').innerHTML=avgDur+' min <span class="kpi-trend">↔</span>';
  const topicCounts=groupCount(filtered,'CallTopic');
  const topTopic=Object.keys(topicCounts).sort((a,b)=>topicCounts[b]-topicCounts[a])[0]||'—';
  document.querySelector('#kpiTopTopic .kpi-value').innerHTML=topTopic+' <span class="kpi-trend">↔</span>';

  // ---------------- Call Volume Trendline ----------------
  const dateCounts={};
  filtered.forEach(d=>{ const dt=safeDate(d.StartTime); if(dt){const key=dt.toISOString().split('T')[0]; dateCounts[key]=(dateCounts[key]||0)+1;}});
  Plotly.react('callTrend',[{x:Object.keys(dateCounts), y:Object.values(dateCounts), type:'scatter', mode:'lines+markers', line:{color:'#4bb3fd'}}],
    {...{paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', font:{color:'#fff'}, margin:{t:40,r:20,b:50,l:50}, transition:{duration:800, easing:'cubic-in-out'}}, xaxis:{title:'Date'}, yaxis:{title:'Number of Calls'}, title:{text:'Call Volume Trendline'}});

  // ---------------- Call Volume by Product ----------------
  const productCounts=groupCount(filtered,'Product');
  Plotly.react('callVolume',[{x:Object.keys(productCounts), y:Object.values(productCounts), type:'bar', marker:{color:Object.values(productCounts).map((v,i)=>`rgba(75,179,253,${0.5+0.05*i})`)}}], 
    {...{paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', font:{color:'#fff'}, margin:{t:40,r:20,b:50,l:50}, transition:{duration:800, easing:'cubic-in-out'}}, xaxis:{title:'Product'}, yaxis:{title:'Number of Calls'}, title:{text:'Call Volume by Product', font:{size:16}}});

  // ---------------- Call Volume by Agent ----------------
  const agentCounts=groupCount(filtered,'Agent');
  Plotly.react('callAgent',[{x:Object.keys(agentCounts), y:Object.values(agentCounts), type:'bar', marker:{color:Object.values(agentCounts).map((v,i)=>`rgba(75,179,253,${0.5+0.05*i})`)}}], 
    {...{paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', font:{color:'#fff'}, margin:{t:40,r:20,b:50,l:50}, transition:{duration:800, easing:'cubic-in-out'}}, xaxis:{title:'Agent'}, yaxis:{title:'Number of Calls'}, title:{text:'Call Volume by Agent', font:{size:16}}});

  // ---------------- Topics by Agent (Stacked) ----------------
  const agents=[...new Set(filtered.map(d=>d.Agent))];
  const topics=[...new Set(filtered.map(d=>d.CallTopic))];
  const traces=topics.map(topic=>{
    return {x:agents, y:agents.map(a=>filtered.filter(d=>d.Agent===a && d.CallTopic===topic).length), name:topic, type:'bar'};
  });
  Plotly.react('topicByAgent', traces, {...{barmode:'stack',paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', font:{color:'#fff'}, margin:{t:40,r:20,b:50,l:50}, transition:{duration:800, easing:'cubic-in-out'}}, xaxis:{title:'Agent'}, yaxis:{title:'Number of Calls'}, title:{text:'Topics by Agent (Stacked)', font:{size:16}}});

  // ---------------- Call Outcomes Summary Table ----------------
  const outcomeCounts=groupCount(filtered,'Outcome');
  let tableHtml='<table><thead><tr><th>Outcome</th><th>Count</th></tr></thead><tbody>';
  for(const key in outcomeCounts){ tableHtml+=`<tr><td>${key}</td><td>${outcomeCounts[key]}</td></tr>`;}
  tableHtml+='</tbody></table>';
  document.getElementById('callOutcomesTable').innerHTML=tableHtml;
}

// ---------------- INIT ----------------
populateFilters();
updateDashboard();
</script>
</body>
</html>
