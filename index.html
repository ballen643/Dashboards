<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Help Desk Form Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://unpkg.com/compromise@13.11.3/builds/compromise.min.js"></script>
<style>
body {
  background: #e6f0f8;
  font-family: 'Roboto', sans-serif;
  margin: 0; padding: 20px; color: #333;
}
h1 { font-size: 28px; margin-bottom: 10px; }
.header { text-align: center; margin-bottom: 20px; }
.filters { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
.filters select, .filters input { padding: 6px; font-size: 14px; border-radius: 4px; border:1px solid #ccc; }
.kpi-row { display:flex; gap:20px; margin-bottom:20px; }
.kpi-card {
  flex:1;
  background: linear-gradient(to bottom, #00507a, #0072C6);
  color:white;
  backdrop-filter: blur(12px);
  border-radius:16px;
  padding:20px;
  text-align:center;
  box-shadow:0 6px 15px rgba(0,0,0,0.25);
}
.kpi-card h2 { margin:0; font-size:18px; font-weight:500; }
.chart-row, .two-column { display:flex; flex-wrap:wrap; gap:20px; margin-bottom:20px; }
.chart-container {
  flex:1 1 100%;
  background: rgba(255,255,255,0.65);
  backdrop-filter: blur(10px);
  border-radius:16px;
  padding:15px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.15);
  position: relative;
}
.chart-container h3 {
  margin-top:0; margin-bottom:10px;
  font-size:16px; border-bottom:2px solid #0072C6; padding-bottom:5px; color:#0072C6;
}
.two-column .chart-container { flex:1; min-width:300px; }
#takeaways {
  background: rgba(255,255,255,0.65); backdrop-filter: blur(10px);
  border-radius:16px; padding:20px; box-shadow:0 6px 15px rgba(0,0,0,0.15);
}
#takeaways h3 { margin-top:0; margin-bottom:10px; font-size:16px; border-bottom:2px solid #0072C6; padding-bottom:5px; color:#0072C6; }
#takeawaysList li { margin-bottom:6px; }
input[type="file"] { display:block; }
table { width:100%; border-collapse: collapse; }
th, td { padding:8px; text-align:left; }
th { background:#0072C6; color:white; }
tbody tr:nth-child(even) { background:#f0f4f8; }
tbody tr:hover { background:#d0e4f2; }
</style>
</head>
<body>

<div class="header">
  <h1>Help Desk Form Dashboard</h1>
</div>

<div class="filters">
  <input type="file" id="uploadJson" accept=".json" />
  <select id="agentFilter"><option value="">All Agents</option></select>
  <input type="date" id="startDate" />
  <input type="date" id="endDate" />
  <input type="text" id="lhFilter" placeholder="Patient LH#" />
  <select id="topicFilter"><option value="">All Topics</option></select>
</div>

<div class="kpi-row">
  <div class="kpi-card"><h2 id="totalCalls">Total Calls: 0</h2></div>
  <div class="kpi-card"><h2 id="avgDuration">Avg Duration: 0 min</h2></div>
  <div class="kpi-card"><h2 id="topTopic">Top Topic: N/A</h2></div>
</div>

<div class="chart-row">
  <div class="chart-container">
    <h3>Call Volume Trend</h3>
    <div id="callTrend" style="width:100%; height:350px;"></div>
  </div>
</div>

<div class="two-column">
  <div class="chart-container">
    <h3>Call Volume by Product</h3>
    <div id="productChart" style="width:100%;height:350px;"></div>
  </div>
  <div class="chart-container">
    <h3>Call Volume by Agent</h3>
    <div id="agentChart" style="width:100%;height:350px;"></div>
  </div>
</div>

<div class="chart-row">
  <div class="chart-container">
    <h3>Top 5 Topics Trendline</h3>
    <div id="topicsTrend" style="width:100%;height:400px;"></div>
  </div>
</div>

<div class="chart-row">
  <div class="chart-container">
    <h3>Call Outcomes Summary</h3>
    <table id="outcomesTable">
      <thead><tr><th>Outcome</th><th>Count</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="takeaways">
  <h3>Key Takeaways & Recommendations</h3>
  <ul id="takeawaysList"></ul>
</div>

<script>
// ===== Mapping & Sample Data =====
function mapJSONKeys(record){
  return {
    Id: record.Id,
    StartTime: record["Start time"] || record.StartTime,
    CompletionTime: record["Completion time"] || record.CompletionTime,
    Email: record.Email,
    Agent: record["Name of the agent that called you (if not listed above):"] || record.Agent || record.Name,
    Product: record.Product,
    PatientLH: record["Patient LH:"] || record.PatientLH,
    CallTopic: record["Call topic (select all that apply)"] || record.CallTopic,
    Outcome: record["What was the outcome of the call? (Select all that apply)"] || record.Outcome,
    Summary: record["Please add a brief summary of the reason for the call:"] || record.Summary,
    Extra: record["Anything else you'd like to share about the call? (Ex. is there an additional resource that needs to be created, is there a new type of issue brewing, etc.?)"] || record.Extra
  };
}

let dashboardData = [mapJSONKeys({
    "Id": 5,
    "Start time": "10/2/2024 8:50",
    "Completion time": "10/2/2024 8:54",
    "Email": "amanda.davis@biogen.com",
    "Name of the agent that called you (if not listed above):": "Lauren Clifford",
    "Product": "Avonex",
    "Patient LH:": "LH4211126",
    "Call topic (select all that apply)": "Adverse event",
    "What was the outcome of the call? (Select all that apply)": "Discussed options for attachments",
    "Please add a brief summary of the reason for the call:": "Agent received an AE via email from Conga and wanted to discuss how to add it to AgDispatch, unable to safe info from CCS email to a PDF, advised to copy and paste into a word document to upload, can also safe that file as a PDF to attach as needed.",
    "Anything else you'd like to share about the call? (Ex. is there an additional resource that needs to be created, is there a new type of issue brewing, etc.?)": "No resources available to discuss how to take info from Conga email and add it to AgDispatch for AEs, resource may be needed."
})];

// ===== Filters =====
function populateFilters() {
  const agents = [...new Set(dashboardData.map(d=>d.Agent))];
  const topics = [...new Set(dashboardData.map(d=>d.CallTopic))];
  document.getElementById('agentFilter').innerHTML = '<option value="">All Agents</option>' + agents.map(a=>`<option value="${a}">${a}</option>`).join('');
  document.getElementById('topicFilter').innerHTML = '<option value="">All Topics</option>' + topics.map(t=>`<option value="${t}">${t}</option>`).join('');
}

function getFilteredData() {
  const agent = document.getElementById('agentFilter').value;
  const topic = document.getElementById('topicFilter').value;
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  const lh = document.getElementById('lhFilter').value;
  return dashboardData.filter(d=>{
    let flag=true;
    if(agent && d.Agent!==agent) flag=false;
    if(topic && d.CallTopic!==topic) flag=false;
    if(start && new Date(d.StartTime)<new Date(start)) flag=false;
    if(end && new Date(d.StartTime)>new Date(end)) flag=false;
    if(lh && !d.PatientLH.includes(lh)) flag=false;
    return flag;
  });
}

// ===== KPI & Charts =====
function updateKPI(filtered){
  const totalCalls = filtered.length;
  document.getElementById('totalCalls').innerText=`Total Calls: ${totalCalls}`;
  if(filtered.length>0){
    const totalMinutes = filtered.reduce((sum,d)=>{
      const start=new Date(d.StartTime);
      const end=new Date(d.CompletionTime);
      return sum+(end-start)/60000;
    },0);
    const avgDuration=(totalMinutes/filtered.length).toFixed(1);
    document.getElementById('avgDuration').innerText=`Avg Duration: ${avgDuration} min`;
    const topTopicCounts={};
    filtered.forEach(d=>topTopicCounts[d.CallTopic]=(topTopicCounts[d.CallTopic]||0)+1);
    const sortedTopics=Object.entries(topTopicCounts).sort((a,b)=>b[1]-a[1]);
    document.getElementById('topTopic').innerText=`Top Topic: ${sortedTopics[0]?sortedTopics[0][0]:'N/A'}`;
  } else {
    document.getElementById('avgDuration').innerText=`Avg Duration: 0 min`;
    document.getElementById('topTopic').innerText=`Top Topic: N/A`;
  }
}

function updateCharts(filtered){
  // Call Volume Trend
  const dateCounts={};
  filtered.forEach(d=>{
    const dt=new Date(d.StartTime).toISOString().split('T')[0];
    dateCounts[dt]=(dateCounts[dt]||0)+1;
  });
  const sortedDates=Object.keys(dateCounts).sort();
  Plotly.newPlot('callTrend',[{x:sortedDates, y:sortedDates.map(d=>dateCounts[d]), type:'scatter', mode:'lines+markers', line:{color:'rgb(0,180,198)'}, hovertemplate:'Calls: %{y}<extra></extra>'}],{margin:{t:30}, xaxis:{title:'Date'}, yaxis:{title:'Calls'}, transition:{duration:500}});

  // Call Volume by Product
  const prodCounts={};
  filtered.forEach(d=>{prodCounts[d.Product]=(prodCounts[d.Product]||0)+1;});
  const sortedProducts=Object.entries(prodCounts).sort((a,b)=>b[1]-a[1]);
  Plotly.newPlot('productChart',[{x:sortedProducts.map(p=>p[0]), y:sortedProducts.map(p=>p[1]), type:'bar', marker:{color:sortedProducts.map(p=>p[1]), colorscale:[[0,'#0072C6'],[1,'#00b4c6']]}, hovertemplate:'Calls: %{y}<extra></extra>'}],{margin:{t:30}, xaxis:{title:'Product'}, yaxis:{title:'Calls'}, transition:{duration:500}});

  // Call Volume by Agent
  const agentCounts={};
  filtered.forEach(d=>{agentCounts[d.Agent]=(agentCounts[d.Agent]||0)+1;});
  const sortedAgents=Object.entries(agentCounts).sort((a,b)=>b[1]-a[1]);
  Plotly.newPlot('agentChart',[{x:sortedAgents.map(a=>a[0]), y:sortedAgents.map(a=>a[1]), type:'bar', marker:{color:sortedAgents.map(a=>a[1]), colorscale:[[0,'#0072C6'],[1,'#00b4c6']]}, hovertemplate:'Calls: %{y}<extra></extra>'}],{margin:{t:30}, xaxis:{title:'Agent'}, yaxis:{title:'Calls'}, transition:{duration:500}});

  // Top 5 Topics Trendline
  const topicCounts={};
  filtered.forEach(d=>{ if(!topicCounts[d.CallTopic]) topicCounts[d.CallTopic]=[]; topicCounts[d.CallTopic].push(new Date(d.StartTime)); });
  const top5Topics=Object.entries(topicCounts).sort((a,b)=>b[1].length-b[1].length).slice(0,5);
  const topicTraces=top5Topics.map(([topic,times],i)=>{
    const countsByDate={};
    times.forEach(t=>{ const dt=t.toISOString().split('T')[0]; countsByDate[dt]=(countsByDate[dt]||0)+1; });
    const sortedDates=Object.keys(countsByDate).sort();
    return {x:sortedDates, y:sortedDates.map(d=>countsByDate[d]), mode:'lines+markers', name:topic, line:{color:`hsl(${i*60},70%,50%)`}, hovertemplate:'%{y}<extra>'+topic+'</extra>'};
  });
  Plotly.newPlot('topicsTrend',topicTraces,{margin:{t:30}, xaxis:{title:'Date'}, yaxis:{title:'Calls'}, transition:{duration:500}});

  // Call Outcomes Table
  const outcomeCounts={};
  filtered.forEach(d=>{outcomeCounts[d.Outcome]=(outcomeCounts[d.Outcome]||0)+1;});
  const sortedOutcomes=Object.entries(outcomeCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
  document.querySelector('#outcomesTable tbody').innerHTML = sortedOutcomes.map(([o,c])=>`<tr><td>${o}</td><td>${c}</td></tr>`).join('');
}

// ===== Key Takeaways & Recommendations =====
function generateTargetedTakeaways(filtered){
  const takeaways=[];
  filtered.forEach(record=>{
    const topic=record.CallTopic||"N/A";
    const summary=record.Summary||"";
    const extra=record.Extra||"";

    if(summary.toLowerCase().includes("unable to safe") || summary.toLowerCase().includes("copy and paste")){
      takeaways.push(`**Topic** - [${topic}], **Recommendation** - Provide step-by-step guidance for attaching AE emails to AgDispatch.`);
    }
    if(extra.toLowerCase().includes("resource") || extra.toLowerCase().includes("no resources")){
      takeaways.push(`**Topic** - [${topic}], **Recommendation** - Create or update internal resources to cover AE email handling procedures.`);
    }
    takeaways.push(`**Topic** - [${topic}], **Recommendation** - Consider training or automation to reduce manual steps and improve efficiency.`);
  });
  document.getElementById('takeawaysList').innerHTML = takeaways.slice(0,5).map(t=>`<li>${t}</li>`).join('');
}

// ===== INITIAL LOAD =====
function updateDashboard(){
  const filtered = getFilteredData();
  updateKPI(filtered);
  updateCharts(filtered);
  generateTargetedTakeaways(filtered);
  populateFilters();
}
updateDashboard();

// ===== FILTER EVENT LISTENERS =====
['agentFilter','topicFilter','startDate','endDate','lhFilter'].forEach(id=>{
  document.getElementById(id).addEventListener('change', updateDashboard);
});

// ===== JSON UPLOAD =====
document.getElementById('uploadJson').addEventListener('change', function(e){
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = function(ev){
      try {
        let jsonData = JSON.parse(ev.target.result);
        if(!Array.isArray(jsonData)) jsonData=[jsonData];
        dashboardData = jsonData.map(mapJSONKeys);
        updateDashboard();
      } catch(err){
        alert("Invalid JSON file. Make sure it is properly formatted.");
      }
    };
    reader.readAsText(file);
  }
});
</script>

</body>
</html>
